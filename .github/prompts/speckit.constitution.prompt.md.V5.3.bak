# command: /speckit.constitution
# short: Create or update project principles and memory system
# description: >
#   This command performs two critical actions:
#   1. Generates the `constitution.md` file based on your spec-md "Project Rules".
#   2. Initializes the complete "Four-in-One" AI Assistant Memory system structure (`ai_assistant_memory`).
#   [V5.1-Merged spec-md èåˆç‰ˆ + ä¸€è‡´æ€§ä¼ æ’­æœºåˆ¶]
# @raycast.schemaVersion 1
# @raycast.title speckit.constitution
# @raycast.mode fullOutput
# @raycast.argument1 { "type": "text", "placeholder": "Describe your project principles (åŸºäº spec-md é¡¹ç›®è§„åˆ™)..." }
# @raycast.icon ğŸ“œ
# @raycast.packageName spec-kit
# @raycast.author Den Delimarsky
# @raycast.authorURL https://github.com/localden
# @raycast.author John Lam
# @raycast.authorURL https://github.com/jflam

# Phase 1: ğŸ“œ Shell Script Execution (Initializing Constitution & Memory System)
# This script will:
# 1. Run the standard spec-kit script to create the feature branch and `constitution.md`.
# 2. [V5 æ³¨å…¥] Create the "Four-in-One" AI memory directory structure.
# 3. [V5 æ³¨å…¥] Copy the master `memory-system-readme.md` template into the new memory system.

#!/bin/bash
set -e

# Load common functions and variables
# IMPORTANT: Adjust this path if your script is in a different location relative to common.sh
source "$(dirname "$0")/../../.specify/scripts/common.sh"

# 1. --- [åŸå§‹é€»è¾‘ä¿ç•™] Standard spec-kit script ---
# This script creates the feature branch, sets up $FEATURE_DIR,
# and creates the initial specs/$FEATURE_DIR/constitution.md file.
bash "$(dirname "$0")/../../.specify/scripts/create-new-feature.sh" \
  --feature-name "constitution" \
  --summary "Establish project constitution and memory system" \
  --skip-pr \
  --auto-checkout \
  --allow-empty-description \
  --description "$1"

# --- [V5 spec-md èåˆæ³¨å…¥] å¼€å§‹ ---

# 2. --- Initialize "Four-in-One" AI Assistant Memory Structure ---
echo "Initializing 'Four-in-One' AI Assistant Memory structure..."

# Define memory system path
# æˆ‘ä»¬å°†è®°å¿†åº“æ”¾åœ¨é¡¹ç›®æ ¹ç›®å½•ï¼Œè€Œä¸æ˜¯ specs/ ç›®å½•ä¸­ï¼Œä»¥ä¾¿äºè®¿é—®
MEMORY_ROOT="ai_assistant_memory"
MEMORY_ROOT_README="$MEMORY_ROOT/README.md"

# è·¯å¾„ä¿®æ­£ï¼šæ¨¡æ¿ä½äº .specify/templates/
MEMORY_TEMPLATE_PATH=".specify/templates/memory-system-readme.md"

# Create root folder
mkdir -p "$MEMORY_ROOT"

# Create the Four Tiers
mkdir -p "$MEMORY_ROOT/docs/global"
mkdir -p "$MEMORY_ROOT/docs/components"
mkdir -p "$MEMORY_ROOT/.context"
mkdir -p "$MEMORY_ROOT/logs"
mkdir -p "$MEMORY_ROOT/work_package_archives"

echo "Memory system directory structure created at '$MEMORY_ROOT'."

# 3. --- Deploy Memory System Blueprint (README) ---
# å°†æˆ‘ä»¬è’¸é¦å¥½çš„é€šç”¨æ¨¡æ¿å¤åˆ¶åˆ°è®°å¿†åº“æ ¹ç›®å½•ï¼Œä½œä¸º"æ´»ç´¢å¼•"
if [ -f "$MEMORY_TEMPLATE_PATH" ]; then
  cp "$MEMORY_TEMPLATE_PATH" "$MEMORY_ROOT_README"
  echo "Deployed 'memory-system-readme.md' to '$MEMORY_ROOT_README'."
else
  echo "WARNING: Master memory template not found at '$MEMORY_TEMPLATE_PATH'. Skipping deployment."
fi

# --- [V5 spec-md èåˆæ³¨å…¥] ç»“æŸ ---

echo "Constitution and AI Memory System initialization complete."
echo "FEATURE_DIR=$FEATURE_DIR"

# Phase 2: ğŸ§  AI Task (Populating the Constitution & Ensuring Consistency)

**è‡´ AI åŠ©æ‰‹ (Copilot/Trae)ï¼š**

ä½ ç°åœ¨å°†æ‰§è¡Œä¸€é¡¹**äº”é‡ä»»åŠ¡**ï¼š**1. å®¡æŸ¥** â†’ **2. å¡«å……** â†’ **3. ä¸€è‡´æ€§ä¼ æ’­æ£€æŸ¥** â†’ **4. åŒæ­¥å½±å“è®°å½•** â†’ **5. æœ€ç»ˆéªŒè¯**ã€‚

## 1. å®¡æŸ¥ (Review)

Shell è„šæœ¬å·²æ‰§è¡Œå®Œæ¯•ã€‚ä½ **å¿…é¡»**é¦–å…ˆç¡®è®¤ä»¥ä¸‹æ–‡ä»¶å’Œç›®å½•ç»“æ„**å·²åœ¨é¡¹ç›®æ ¹ç›®å½•è¢«æˆåŠŸåˆ›å»º**ï¼š

* `specs/$FEATURE_DIR/constitution.md` (è¿™æ˜¯ä½ çš„ä¸»è¦ç›®æ ‡æ–‡ä»¶)
* `ai_assistant_memory/` (AI è¾…åŠ©è®°å¿†åº“æ ¹ç›®å½•)
* `ai_assistant_memory/README.md` (è®°å¿†åº“è“å›¾ï¼Œå³ 'memory-system-readme.md' çš„å‰¯æœ¬)
* `ai_assistant_memory/docs/`
* `ai_assistant_memory/.context/`
* `ai_assistant_memory/logs/`
* `ai_assistant_memory/work_package_archives/`

## 2. å¡«å…… (Populate)

ä½ çš„æ ¸å¿ƒä»»åŠ¡æ˜¯å¡«å…… `specs/$FEATURE_DIR/constitution.md` æ–‡ä»¶ã€‚

**[V5 spec-md èåˆæŒ‡ä»¤]**
`constitution.md` æ–‡ä»¶åœ¨æˆ‘ä»¬çš„ `spec-md` ä½“ç³»ä¸­ï¼Œå¯¹åº”çš„æ˜¯**"é¡¹ç›®è§„åˆ™ (Project Rules)"**ï¼Œå³ä½ ï¼ˆAI æ‰§è¡Œè€…ï¼‰åœ¨æœ¬é¡¹ç›®ä¸­å¿…é¡»éµå®ˆçš„æ ¸å¿ƒè¡Œä¸ºå‡†åˆ™ã€‚

**ç¦æ­¢ï¼š** **ä¸è¦**ä½¿ç”¨"Gemini ç›‘å·¥åŸåˆ™"æˆ–"åä½œåŸåˆ™"ï¼Œé‚£äº›æ˜¯ç»™æˆ˜ç•¥ AI (Gemini) çš„ã€‚
**æ‰§è¡Œï¼š** ä½ å¿…é¡»å°†ç”¨æˆ·çš„æç¤ºï¼ˆ`$1`ï¼‰â€”â€”å³æˆ‘ä»¬çš„**"Trae é¡¹ç›®è§„åˆ™"**â€”â€”æç‚¼å¹¶æ ¼å¼åŒ–åï¼Œå¡«å…¥ `specs/$FEATURE_DIR/constitution.md` æ–‡ä»¶ä¸­ã€‚

**è¯·æ‰§è¡Œä»¥ä¸‹æ“ä½œï¼š**

1. **è¯»å–ç”¨æˆ·è¾“å…¥ï¼š**
   ```
   {{.Argument1}}
   ```
2. **åˆ†æå¹¶æ’°å†™ï¼š** å°†ä¸Šè¿°ç”¨æˆ·è¾“å…¥ï¼ˆå³"é¡¹ç›®è§„åˆ™"ï¼‰çš„å†…å®¹ï¼Œä»¥æ¸…æ™°ã€ç»“æ„åŒ–çš„ Markdown æ ¼å¼ï¼Œ**å†™å…¥å¹¶è¦†ç›–**åˆ° `specs/$FEATURE_DIR/constitution.md` æ–‡ä»¶ä¸­ã€‚

## 3. ä¸€è‡´æ€§ä¼ æ’­æ£€æŸ¥ (Consistency Propagation Check)

**[èåˆè‡ªåŸå§‹ spec-kit ç»éªŒé€»è¾‘]**

åœ¨ä½ å®Œæˆ `constitution.md` çš„å¡«å……åï¼Œä½ **å¿…é¡»**æ‰§è¡Œä»¥ä¸‹ä¸€è‡´æ€§ä¼ æ’­æ£€æŸ¥ï¼Œä»¥ç¡®ä¿é¡¹ç›®è§„åˆ™çš„å˜æ›´ä¸ä¼šå¯¼è‡´å…¶ä»–æ–‡ä»¶å¤±å»åŒæ­¥ï¼š

### 3.1 æ¨¡æ¿æ–‡ä»¶æ£€æŸ¥

**æ£€æŸ¥ä»¥ä¸‹æ¨¡æ¿æ–‡ä»¶**ï¼ˆå¦‚æœå­˜åœ¨ï¼‰ï¼Œç¡®è®¤å®ƒä»¬ä¸æ–°çš„ constitution è§„åˆ™ä¿æŒä¸€è‡´ï¼š

* `.specify/templates/plan-template.md` - æ£€æŸ¥æ˜¯å¦æœ‰"Constitution Check"æˆ–è§„åˆ™å¼•ç”¨
* `.specify/templates/spec-template.md` - æ£€æŸ¥èŒƒå›´/éœ€æ±‚å¯¹é½
* `.specify/templates/tasks-template.md` - æ£€æŸ¥ä»»åŠ¡åˆ†ç±»æ˜¯å¦åæ˜ æ–°åŸåˆ™
* `AWP-template.md` (å¦‚æœå­˜åœ¨äºé¡¹ç›®æ ¹ç›®å½•æˆ– `.specify/templates/`) - æ£€æŸ¥è‡ªä¸»å·¥ä½œåŒ…æ¨¡æ¿çš„è§„åˆ™å¯¹é½

### 3.2 å‘½ä»¤æ–‡ä»¶æ£€æŸ¥

**æ£€æŸ¥ `.specify/templates/commands/*.md`** æˆ– `.github/prompts/*.md` ä¸­çš„å…¶ä»–å‘½ä»¤æ–‡ä»¶ï¼š
* éªŒè¯æ˜¯å¦æœ‰è¿‡æ—¶çš„å¼•ç”¨ï¼ˆä¾‹å¦‚ï¼šä»…é’ˆå¯¹ç‰¹å®šAIåŠ©æ‰‹çš„åç§°ï¼‰
* ç¡®ä¿é€šç”¨æŒ‡å¯¼å·²æ›´æ–°

### 3.3 æ–‡æ¡£æ£€æŸ¥

**æ£€æŸ¥é¡¹ç›®æ–‡æ¡£**ï¼š
* `README.md` - æ£€æŸ¥æ˜¯å¦å¼•ç”¨äº†å·²å˜æ›´çš„åŸåˆ™
* `docs/` ç›®å½•ä¸‹çš„ç›¸å…³æ–‡æ¡£
* **`ai_assistant_memory/README.md`** (æ–°åˆ›å»ºçš„è®°å¿†åº“è“å›¾) - ç¡®è®¤ä¸ constitution çš„åè°ƒæ€§

### 3.4 æ£€æŸ¥è¾“å‡º

**ä½ å¿…é¡»**æŠ¥å‘Šä»¥ä¸‹å†…å®¹ï¼š
* âœ… **å·²æ£€æŸ¥ä¸”æ— éœ€æ›´æ–°**çš„æ–‡ä»¶åˆ—è¡¨
* âš ï¸ **å¯èƒ½éœ€è¦äººå·¥å®¡æŸ¥**çš„æ–‡ä»¶åˆ—è¡¨ï¼ˆè¯´æ˜åŸå› ï¼‰
* âŒ **æ˜ç¡®éœ€è¦æ›´æ–°**çš„æ–‡ä»¶åˆ—è¡¨ï¼ˆè¯´æ˜ä¸ä¸€è‡´ä¹‹å¤„ï¼‰

## 4. åŒæ­¥å½±å“è®°å½• (Sync Impact Record)

**[èåˆå¹¶ç®€åŒ–è‡ªåŸå§‹ Sync Impact Report é€»è¾‘]**

åœ¨ä½ å®Œæˆä¸€è‡´æ€§æ£€æŸ¥åï¼Œä½ **å¿…é¡»**ç”Ÿæˆä¸€ä»½**å˜æ›´æ‘˜è¦æŠ¥å‘Š**ï¼Œå‘ç”¨æˆ·è¯´æ˜ï¼š

### 4.1 å˜æ›´æ‘˜è¦

* **Constitution æ–‡ä»¶è·¯å¾„**ï¼š`specs/$FEATURE_DIR/constitution.md`
* **ä¸»è¦å˜æ›´å†…å®¹**ï¼šï¼ˆç®€è¦æè¿°ç”¨æˆ·è¾“å…¥çš„æ ¸å¿ƒåŸåˆ™ï¼‰
* **è®°å¿†åº“çŠ¶æ€**ï¼šâœ… å·²åˆå§‹åŒ– `ai_assistant_memory/` å››ä½ä¸€ä½“ç»“æ„

### 4.2 å½±å“èŒƒå›´

åˆ—å‡º**å¯èƒ½å—å½±å“çš„æ–‡ä»¶**ï¼š
* æ¨¡æ¿æ–‡ä»¶ï¼š[åˆ—å‡ºåœ¨æ­¥éª¤3ä¸­è¯†åˆ«çš„æ–‡ä»¶]
* æ–‡æ¡£æ–‡ä»¶ï¼š[åˆ—å‡ºéœ€è¦å®¡æŸ¥çš„æ–‡æ¡£]
* å‘½ä»¤æ–‡ä»¶ï¼š[åˆ—å‡ºéœ€è¦å®¡æŸ¥çš„å‘½ä»¤]

### 4.3 åç»­è¡ŒåŠ¨å»ºè®®

* **ç«‹å³æ‰§è¡Œ**ï¼šï¼ˆå¦‚æœæœ‰æ˜ç¡®éœ€è¦æ›´æ–°çš„æ–‡ä»¶ï¼‰
* **å»ºè®®å®¡æŸ¥**ï¼šï¼ˆå¦‚æœæœ‰éœ€è¦äººå·¥åˆ¤æ–­çš„æ–‡ä»¶ï¼‰
* **å»ºè®® commit ä¿¡æ¯**ï¼š`docs: establish constitution and init memory system (V5.1-Merged)`

## 5. æœ€ç»ˆéªŒè¯ (Final Validation)

**[èåˆè‡ªåŸå§‹éªŒè¯æ­¥éª¤]**

åœ¨ä½ å‡†å¤‡ç»“æŸä»»åŠ¡å‰ï¼Œä½ **å¿…é¡»**æ‰§è¡Œä»¥ä¸‹æœ€ç»ˆéªŒè¯ï¼š

### 5.1 Constitution æ–‡ä»¶éªŒè¯

* âœ… `specs/$FEATURE_DIR/constitution.md` å·²æˆåŠŸåˆ›å»º
* âœ… æ–‡ä»¶å†…å®¹ç»“æ„æ¸…æ™°ã€æ ¼å¼æ­£ç¡®
* âœ… æ— æœªå¤„ç†çš„å ä½ç¬¦æˆ–é”™è¯¯æ ‡è®°
* âœ… å†…å®¹ç¬¦åˆ spec-md "é¡¹ç›®è§„åˆ™"çš„å®šä½

### 5.2 è®°å¿†åº“ç»“æ„éªŒè¯

* âœ… `ai_assistant_memory/` æ ¹ç›®å½•å·²åˆ›å»º
* âœ… å››ä¸ªå­ç›®å½•å·²åˆ›å»ºï¼š`docs/`, `.context/`, `logs/`, `work_package_archives/`
* âœ… `ai_assistant_memory/README.md` å·²ä»æ¨¡æ¿æ­£ç¡®éƒ¨ç½²

### 5.3 æœ€ç»ˆæŠ¥å‘Š

**ä½ å¿…é¡»**å‘ç”¨æˆ·æäº¤ä¸€ä»½æœ€ç»ˆç¡®è®¤å£°æ˜ï¼š

```
âœ… ä»»åŠ¡å®Œæˆç¡®è®¤ï¼š
- Constitution æ–‡ä»¶ï¼šspecs/$FEATURE_DIR/constitution.md âœ…
- è®°å¿†åº“ç»“æ„ï¼šai_assistant_memory/ âœ…
- ä¸€è‡´æ€§æ£€æŸ¥ï¼šå·²å®Œæˆ âœ…
- åŒæ­¥å½±å“è®°å½•ï¼šå·²ç”Ÿæˆ âœ…

[åœ¨æ­¤å¤„é™„ä¸Šæ­¥éª¤4çš„"åŒæ­¥å½±å“è®°å½•"å†…å®¹]
```

---

**æ‰§è¡Œæ ¼å¼è¦æ±‚**ï¼š

* ä½¿ç”¨ Markdown æ ¼å¼è¾“å‡ºæ‰€æœ‰æŠ¥å‘Š
* ä¿æŒæ¸…æ™°çš„ç« èŠ‚å±‚æ¬¡
* ä½¿ç”¨ âœ… âš ï¸ âŒ ç¬¦å·æ ‡è®°çŠ¶æ€
* æä¾›å…·ä½“çš„æ–‡ä»¶è·¯å¾„å’Œå˜æ›´è¯´æ˜
